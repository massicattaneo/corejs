Object.prototype.extend=function(){for(var t={},n=0,e=arguments.length;e>n;n++){var i=arguments[n];Object.keys(i).forEach(function(n){t[n]=i[n]})}return t};var Collection=function(){var t=function(t,n,e){var i=[];t.forEach(function(e,s){i.push({a1:t[s],a2:n[s]})}),i.sort(function(t,n){return e?t.a1>n.a1?-1:t.a1===n.a1?0:1:t.a1<n.a1?-1:t.a1===n.a1?0:1}),i.forEach(function(e,i){t[i]=e.a1,n[i]=e.a2})},n=function(t,n,e){var i=t.splice(e,1,t[n]);t[n]=i[0]},e={VERSUS:{ascending:0,descending:1},initValues:function(){this.items=[],this.keys=[],this.__counterId=0},size:function(){return this.items.length},isEmpty:function(){return 0===this.size()},add:function(t,n){var e="undefined"==typeof n?this.__counterId++:n;return this.keys.push(e),this.items.push(t),e},sortByItem:function(n){t(this.items,this.keys,n)},sortByKey:function(n){t(this.keys,this.items,n)},sortBy:function(n,e){var i=[],s=[];this.forEach(function(t){i.push(t[n]),s.push(t[n])}),t(i,this.keys,e),t(s,this.items,e)},newItem:function(t){var n=new this.ClassType;return this.add(n,t),n},get:function(t){return this.items[this.keys.indexOf(t)]},getAt:function(t){return this.items[t]},getKeyAt:function(t){return this.keys[t]},set:function(t,n){var e=this.keys.indexOf(t);return this.items[e]=n,e},setAt:function(t,n){return this.items[t]=n,this.keys[t]},setKey:function(t,n){var e=this.keys.indexOf(t);return this.keys[e]=n,e},getLast:function(t){return this.items[this.keys.lastIndexOf(t)]},swap:function(t,e){n(this.items,t,e),n(this.keys,t,e)},getCollection:function(t,n){var e=Collection();return this.forEach(function(i,s){i[t]===n&&e.add(i,s)}),e},indexOf:function(t){return this.items.indexOf(t)},addCollection:function(t){t.forEach(function(t,n){this.add(t,n)},this)},remove:function(t){var n,e=0;do e=this.keys.indexOf(t),-1!==e&&(this.keys.splice(e,1),n=this.items.splice(e,1));while(-1!==e);return n[0]||null},removeAt:function(t){return this.keys.splice(t,1),this.items.splice(t,1)[0]},removeItem:function(t){var n=this.indexOf(t),e=this.keys[n];return this.remove(e)},filter:function(t){var n=Collection();return this.forEach(function(e,i){"undefined"!=typeof t&&i!==t||n.add(e,t)}),n},clone:function(){return this.filter()},forEach:function(t,n){for(var e=0;e<this.items.length;e++)t.call(n||this,this.items[e],this.keys[e],parseInt(e,10))},clear:function(){this.items=[],this.keys=[]},toArray:function(){var t=[];return this.forEach(function(n){t.push(n)}),t},toJSON:function(){var t={};return this.forEach(function(n,e){t[e]=n}),t}};return function(t){var n=Object.extend(e);return n.initValues(),Array.isArray(t)?t.forEach(function(t){n.add(t)}):n.ClassType=t,n}}(),Need=function(){var t={WAIT:0,DONE:1,FAIL:2},n=Collection(),e=function(t,n,e){t.returnData[n]=e,t.status=n,t.collection.filter(n).forEach(function(n){n(e,t.id)})},i=function(t,n,e){t.status===n?e(t.returnData[n],t.id):t.collection.add(e,n)},s=function(){var n={},s={returnData:[],status:t.WAIT,id:-1,collection:Collection()};return n.resolve=function(n){s.status===t.WAIT&&e(s,t.DONE,n)},n.fail=function(n){e(s,t.FAIL,n)},n.then=function(n){i(s,t.DONE,n)},n.onFail=function(n){i(s,t.FAIL,n)},n.status=function(){return s.status},n.setId=function(t){s.id=t},n},r=function(n){var e=n.errors;return n.status===t.DONE&&(e=n.args.slice(0)),e},o=function(n,e,i){i.status===n?e.apply(null,r(i)):n===t.DONE?i.done.push(e):i.fail=e},u=function(n){var e={},i={done:[],fail:function(){},args:[],errors:[],count:0,counter:0,status:t.WAIT,collection:Collection()};return e.add=function(t){return t.setId(i.counter++),i.collection.add(t),t.then(function(t,n){e.itemOnDone(t,n)}),t.onFail(function(t){e.itemOnFail(t)}),this},e.itemOnDone=function(n,e){i.count+=1,i.args[e]=n,i.count===i.collection.size()&&(i.status=t.DONE,i.done.forEach(function(t){t.apply(this,r(i))}))},e.itemOnFail=function(n){i.errors.push(n),i.status=t.FAIL,i.fail.apply(this,r(i))},e.then=function(n){o(t.DONE,n,i)},e.onFail=function(n){o(t.FAIL,n,i)},e.get=function(t){return i.collection.get(t)},e.status=function(){return i.status},n.forEach(function(t){e.add(t)}),e},c=function(t,e){var i={},s={needs:Need([])},r=function(t){if(n.get(t))s.needs.add(n.get(t));else{var e=Need();s.needs.add(e),n.add(e,t)}},o=e(r);return n.get(t)?(o.__namespace=t,n.get(t).resolve(o)):n.add(Need(),t),s.needs.then(function(){for(var t={},n=0;n<arguments.length;n++)t[arguments[n].__namespace]=arguments[n];e(function(n){return t[n]()})()}),i.status=function(){return s.needs.status()},i};return function(t,n){return void 0===t?s():Array.isArray(t)?u(t):c(t,n)}}();